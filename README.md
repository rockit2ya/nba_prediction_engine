# üèÄ NBA Predictive Analytics Engine (v3.0)

This README covers the features, technical architecture, mathematical modeling, and deployment steps for the NBA Prediction Engine (engine).

### **Overview**

The **NBA Pro Engine (V3)** is a situational analytics tool designed for high-fidelity point spread predictions. Unlike basic models that use season averages, this engine prioritizes "Current Form" and "Immediate Context" to find market inefficiencies. It leverages the **NBA's Four-Factors** and advanced efficiency ratings to calculate a "Fair Line" (Projected Spread) for daily matchups. Unlike basic models that rely on season averages, this engine incorporates real-time injury scraping, fatigue adjustments (Back-to-Backs), and dynamic home-court weighting.

### **Key Pro Features**

- **Situational Modeling:** Factors in Back-to-Back (B2B) fatigue and dynamic Home Court Advantage (HCA).
- **Bayesian Star Tax:** Uses individual "On-Off" metrics weighted by official injury status (OUT, GTD, Doubtful).
- **Live Scoreboard V3:** High-reliability connection to real-time game schedules and scores.
- **Optimized Performance:** Multi-threaded API calls and persistent sessions for sub-2-second analysis.
- **Kelly Criterion Integration:** Calculates conservative bankroll risk for every edge found.
- **Emergency Fallback:** Continues working even if the NBA API is down using baseline league data.

### **Project Structure & File Guide**

| File/Folder                      | Purpose                                                                                                                                                                    |
| -------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `nba_engine_ui.py`               | Main command-line interface for running the NBA analytics engine and interacting with users. Handles all user input, analysis, and logging. Supports graceful Ctrl+C exit. |
| `nba_analytics.py`               | Core analytics logic and spread prediction. Bayesian Star Tax, late-scratch detection, fatigue adjustments. Reads from pre-fetched cache files.                            |
| `nba_data_fetcher_advanced.py`   | Selenium-based NBA.com advanced stats scraper. Used as a fallback if `nba_api` fails.                                                                                      |
| `injury_scraper.py`              | Scrapes CBS Sports for NBA injury data and caches to `nba_injuries.csv`.                                                                                                   |
| `nba_lineup_and_news_monitor.py` | Scrapes ESPN for NBA lineups/injuries and fetches breaking news via ESPN RSS feed.                                                                                         |
| `rest_penalty_scraper.py`        | Scrapes and caches rest/fatigue penalty data per team to `nba_rest_penalty_cache.csv`.                                                                                     |
| `cache_nba_news.py`              | Fetches ESPN RSS news feed and caches to `nba_news_cache.json` for offline use.                                                                                            |
| `post_mortem.py`                 | Post-game analysis tool for reviewing bet outcomes and model accuracy.                                                                                                     |
| `update_results.py`              | Auto-fetches final scores from NBA API and updates bet tracker CSVs with WIN/LOSS/PUSH results.                                                                            |
| `fetch_all_nba_data.sh`          | Bash script to run all data fetchers/scrapers and verify all caches are up to date.                                                                                        |
| `fetch_all_nba_data.log`         | Log file generated by `fetch_all_nba_data.sh` with details of each fetcher run.                                                                                            |
| `nba_stats_cache.json`           | Cached NBA team advanced stats (auto-generated/updated by fetchers and engine).                                                                                            |
| `nba_injuries.csv`               | Cached injury report data (auto-generated by `injury_scraper.py`).                                                                                                         |
| `nba_news_cache.json`            | Cached NBA news items from ESPN RSS (auto-generated by `cache_nba_news.py`).                                                                                               |
| `nba_rest_penalty_cache.csv`     | Cached rest/fatigue penalty data per team (auto-generated by `rest_penalty_scraper.py`).                                                                                   |
| `game_schedule.csv`              | Local schedule data for rest/fatigue calculations.                                                                                                                         |
| `bet_tracker_YYYY-MM-DD.csv`     | Daily log of all bets, fair lines, edges, Kelly calculations, sportsbook, odds, and real-dollar tracking.                                                                  |
| `requirements.txt`               | Python dependencies for the project.                                                                                                                                       |
| `BETTING_GUIDE.md`               | Guide to using the engine for betting, including manual steps and best practices.                                                                                          |
| `README.md`                      | This file.                                                                                                                                                                 |

---

## üö¶ Recommended User Workflow

Follow these steps to get the most out of the NBA Prediction Engine:

1. **Update and Fetch Data**
   - Before analyzing games, refresh all caches by either:
     - Running `bash fetch_all_nba_data.sh` from the terminal, or
     - Using the `[R] Refresh Data` command inside the engine UI.
   - This fetches advanced stats, injury reports, rest penalties, and news from ESPN/CBS/RSS.

2. **Analyze Games and Generate Recommendations**
   - Run the engine: `python nba_engine_ui.py`
   - The UI displays today's NBA schedule from cached data.
   - For each game, input the market line when prompted.
   - The engine calculates the fair line, edge, and confidence, factoring in:
     - Advanced stats (offensive/defensive ratings, pace)
     - Injury data (CBS/ESPN)
     - Late-breaking news (ESPN RSS)
     - Rest/fatigue penalties and dynamic home-court advantage

3. **Automated Flagging**
   - If late-breaking lineup/injury news is detected, the UI will alert you to double-check before betting.
   - Only games with edge ‚â• 5 and HIGH confidence are recommended as ‚ÄúSTRONG SIGNAL‚Äù bets.

4. **Logging and Tracking**
   - Each analysis is logged to a date-stamped CSV (`bet_tracker_YYYY-MM-DD.csv`) for post-mortem review.
   - You'll be prompted for **Sportsbook**, **Odds**, and **Bet amount** (all optional ‚Äî press Enter to skip).
   - When results are populated, `update_results.py` auto-calculates the **Payout** column using American odds math.

5. **Post-Analysis**
   - Run `python update_results.py` to auto-populate WIN/LOSS results from the NBA API.
   - Run `python post_mortem.py` for the full performance analyzer:
     - **[1] Single-Day Post-Mortem** ‚Äî detailed win/loss breakdown with injury and margin analysis
     - **[2] Lifetime Performance Dashboard** ‚Äî all-time record, ROI, streaks, drawdown, and pro-level verdict
     - **[3] Edge Calibration Report** ‚Äî do bigger edges win at higher rates?
     - **[4] Daily Trend & Profit Curve** ‚Äî cumulative P/L over time with ASCII chart
     - **[5] Bankroll Tracker** ‚Äî real-dollar bankroll tracking with Kelly bet sizing

This workflow ensures your predictions are based on the most current cached data, with built-in alerts for late-breaking news and injuries, and a clear audit trail for every bet.

---

## üìä Post-Bet Analysis: Entering Wins & Losses

After games finish, update your bet tracker CSV and run the post-mortem tool to review model accuracy.

### Step 1: Update Results (Automatic)

Run the result updater to automatically fetch final scores and populate WIN/LOSS:

```bash
python update_results.py
```

The script will:

1. List all available `bet_tracker_*.csv` files with their pending/complete status
2. Let you select a specific file or update all pending files at once
3. Fetch final scores from the NBA API
4. Determine WIN/LOSS based on whether your pick covered the spread
5. Save the updated CSV with results and final scores

**Example output:**

```
  Available bet tracker files:

    [1] bet_tracker_2026-02-10.csv  (4 games, 4 pending)
    [2] bet_tracker_2026-02-09.csv  (11 games, all complete)
    [A] Update ALL files with pending games
    [Q] Quit

  Select: 1
  ‚úÖ G1: Pacers @ Knicks ‚Üí WIN  (Final Score: Pacers 115 - Knicks 108)
  ‚ùå G2: Clippers @ Rockets ‚Üí LOSS  (Final Score: Clippers 99 - Rockets 112)
  üü∞ G3: Lakers @ Suns ‚Üí PUSH  (Final Score: Lakers 110 - Suns 120)
```

### Step 1b: Manual Update (Alternative)

You can also edit the CSV directly. Open the bet tracker CSV and change each row's `Result` from `PENDING` to `WIN` or `LOSS`. Add the final score in the `Notes` column for margin analysis.

| Column   | Value                                | Description                                           |
| -------- | ------------------------------------ | ----------------------------------------------------- |
| `Book`   | `DraftKings`, `FanDuel`, etc.        | Sportsbook (optional, entered at bet time)            |
| `Odds`   | `-110`, `+150`, etc.                 | American odds (optional, entered at bet time)         |
| `Bet`    | `50`, `100`, etc.                    | Dollar amount wagered (optional)                      |
| `Result` | `WIN`, `LOSS`, `PUSH`, or `PENDING`  | Auto-populated by `update_results.py` or set manually |
| `Payout` | `95.45`, `-50`, `0.00`, etc.         | Auto-calculated from Bet/Odds on WIN/LOSS/PUSH        |
| `Notes`  | `Final Score: Team1 123 - Team2 110` | Auto-populated or set manually for margin analysis    |

### Step 2: Run the Post-Mortem Analyzer

```bash
python post_mortem.py
```

You'll see a menu with five options:

```
  [1] Single-Day Post-Mortem
  [2] Lifetime Performance Dashboard
  [3] Edge Calibration Report
  [4] Daily Trend & Profit Curve
  [5] Bankroll Tracker
  [Q] Quit
```

### Menu Options

**[1] Single-Day Post-Mortem** ‚Äî Enter a date to review that day's bets:

- Win/Loss/Pending counts for all bets and high-signal bets (Edge ‚â• 5)
- Loss details with margin of defeat, injury impact, and low-edge flags
- Win details with average margin of victory
- Day P/L in units and real dollars (when bet amounts are tracked)

**[2] Lifetime Performance Dashboard** ‚Äî All-time aggregate stats:

- Overall record, win rate, and letter grade (Elite / Pro-Level / Profitable / Below Breakeven)
- Total P/L in units and Kelly-weighted units
- **üí∞ Real Money P/L** ‚Äî net profit/loss in dollars, total wagered, and ROI (shown when bet amounts are tracked)
- **Sportsbook breakdown** ‚Äî win rate and P/L per book (DraftKings, FanDuel, etc.)
- High-signal bet performance
- Edge calibration (do bigger edges win more often?)
- Streaks, max drawdown, and current balance
- Daily trend table (with dollar P/L column when available)
- **Pro-Level Verdict** ‚Äî 5-point checklist:
  - ATS Win Rate > 52.4% (break-even at -110)
  - Positive ROI
  - High-Signal Win Rate > 55%
  - Edge Calibration (higher edges = higher win rate)
  - Sufficient Sample Size (20+ bets)

**[3] Edge Calibration Report** ‚Äî Fine-grained breakdown by edge bucket (0‚Äì3, 3‚Äì5, 5‚Äì8, 8‚Äì10, 10‚Äì15, 15‚Äì20, 20+) with visual bars, P/L, and Edge-vs-Win-Rate correlation.

**[4] Daily Trend & Profit Curve** ‚Äî Day-by-day P/L with cumulative rolling win rate and an ASCII profit curve chart.

**[5] Bankroll Tracker** ‚Äî Set a starting bankroll and unit size, then track day-by-day balance changes with real dollars. Includes Quarter-Kelly recommended bet sizing based on lifetime win rate.

---

## üß∞ Optional Utility Tools

These scripts provide additional analysis, data checks, and manual overrides for advanced users:

- **injury_scraper.py**
  - Manually scrape and save the latest NBA injury data from CBS Sports for custom analysis or troubleshooting.
  - Usage: `python injury_scraper.py`

- **nba_lineup_and_news_monitor.py**
  - Scrape ESPN for lineups/injuries and fetch NBA news headlines via RSS. Useful for monitoring late scratches and breaking news.
  - Usage: `python nba_lineup_and_news_monitor.py`

These tools are optional but recommended for power users who want deeper insight, custom data, or extra validation before betting.

---

## üõ†Ô∏è VS Code Installation & Setup (macOS)

### **Step 1: Open Your Project**

1. Launch **Visual Studio Code**.
2. Go to `File > Open Folder...` and select the folder containing your `.py` files.

### **Step 2: Set Up a Virtual Environment (Recommended)**

This keeps your project libraries isolated and prevents "Module Not Found" errors.

1. Open the integrated terminal in VS Code (`Terminal > New Terminal`).
2. Type the following commands:

```bash
python3 -m venv .venv
source .venv/bin/activate

```

3. You should now see `(.venv)` at the start of your terminal prompt.

### **Step 3: Install Dependencies**

Run this command in your VS Code terminal to install dependencies:

```bash
pip install -r requirements.txt

```

### **Step 4: Select the Python Interpreter**

1. Press `Cmd + Shift + P` and type **"Python: Select Interpreter"**.
2. Choose the one that starts with `./.venv/bin/python`. This ensures VS Code uses the libraries you just installed.

### **Step 5: Run the Engine**

1. Open `nba_engine_ui.py` in the editor.
2. Click the **"Play"** button in the top-right corner, or type this in the terminal:

```bash
python nba_engine_ui.py

```

### **VS Code YouTube Tutorials**

- [How to Set Up Python Development in VS Code on Mac](https://www.youtube.com/watch?v=4CJHjqZfH7A) - This video provides a clear walkthrough for setting up a virtual environment and running Python scripts on macOS, which is essential for getting your NBA engine running smoothly.
- [How to Run Python in Visual Studio Code on Windows 10/11](http://www.youtube.com/watch?v=mIVB-SNycKI) - Step-by-step guide you on how to run Python in Visual Studio Code on Windows 10/11 + Python for Python Developers on Windows 10/11 OS.

---

## üèÅ Pro Troubleshooting

- **Slow Data:** The first run creates the cache. Subsequent runs will be nearly instant.
- **Connection Error:** If the NBA blocks your Wi-Fi, toggle your iPhone's **Airplane Mode** for 5 seconds to reset your hotspot's IP address.
- **Missing Data:** If the CSV isn't updating, ensure you have "Write" permissions for the folder you opened in VS Code.

---

## üß† The "Nitty-Gritty": How the Engine is Modeled

The model operates on the principle that NBA games are won by possession efficiency. It translates advanced ratings into a point spread using the following multi-layer logic:

### 1. The Core Efficiency Formula

We calculate the expected point differential per 100 possessions by cross-referencing offensive and defensive ratings over a **rolling 10-game window**:

$$Raw\ Diff = (OffRtg_{home} - DefRtg_{away}) - (OffRtg_{away} - DefRtg_{home})$$

This value is then normalized to the projected pace of the game:

$$Points_{spread} = Raw\ Diff \times \left( \frac{Pace_{avg}}{100} \right)$$

### 2. Situational Adjustments (The "Edge")

To move beyond a 50% accuracy rate, the engine applies three situational layers:

- **Fatigue Adjuster (B2B):** Detects if a team played the previous night. A **-2.5 point penalty** is applied to tired teams to account for drops in rebounding and defensive intensity.
- **Dynamic Home Court (HCA):** Instead of a flat +3.0, the engine calculates a team-specific HCA based on their season-long Home vs. Road Net Rating.
- **Star Tax (Injury Impact):** Scrapes live injury reports. If a star is out, the engine looks up their individual `On-Off Plus/Minus` and subtracts that value from the team's total power rating.

### 3. The Sanity Check (Volatility Filter)

If the **Calculated Edge** (Difference between Engine Line and Market Line) exceeds **11.0 points**, the engine flags the game as high-volatility. This usually indicates a market-moving event (like a trade or late scratch) that the math has detected but requires human verification.

---

### üìâ Mathematical Modeling Section

The engine uses a series of possession-based linear equations to derive the fair value of a matchup.

#### 1. Efficiency Differential ()

We first calculate the net efficiency margin by comparing how each team's offense performs against the opponent's defense:

$$Raw\ Diff = (OffRtg_{home} - DefRtg_{away}) - (OffRtg_{away} - DefRtg_{home})$$

#### 2. Pace Normalization

Since is calculated per 100 possessions, we must scale it to the game's projected (the total number of possessions for both teams):

$$Points_{spread} = Raw\ Diff \times \left( \frac{Pace_{avg}}{100} \right)$$

#### 3. Situational Final Line ()

The final projected spread incorporates the Dynamic Home Court Advantage (), the Fatigue Adjustment (), and the Star Tax ():

$$Fair\ Line = Points_{spread} + HCA + \sum Rest + \sum Injury$$

---

## üõ†Ô∏è Extreme Edge

Those "Extreme Edge" alerts are exactly what you want to see‚Äîit means the engine is doing its job by flagging games where the math significantly diverges from the Vegas line.

For the **February 8, 2026** slate you just ran, your engine is reacting to a massive amount of "noise" in the injury reports. Here is the breakdown of why those specific games triggered alerts:

### üîç Breakdown of the "Extreme" Edges

| Game              | Edge          | Why the Alert Triggered                                                                                                                                                                                                                                                             |
| ----------------- | ------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **G1: NYK @ BOS** | **12.59 pts** | **The Tatum Factor:** Jayson Tatum is officially **OUT** (Achilles). Your engine's "Star Tax" likely hammered the Celtics' rating, while the market is still giving them a -3.5 favorite status based on their depth.                                                               |
| **G3: IND @ TOR** | **16.24 pts** | **The Zubac/Haliburton Void:** This is a "chaos" game. The Pacers are missing Tyrese Haliburton and Ivica Zubac, while Toronto has several "Questionables." The 16-point gap suggests the market thinks Toronto is healthy, while your engine sees two depleted rosters.            |
| **G4: LAC @ MIN** | **10.6 pts**  | **Clippers Trade/Injury Flux:** The Clippers are listed with several "Out" players (Garland, Mathurin, Jackson) due to pending trades and injuries. Your engine likes the Clippers +9.5 because it sees Minnesota's Poeltl being out as a bigger net-negative than the market does. |

---

### üõ†Ô∏è How to Handle these Alerts

When you see an edge over 10 points, **don't just bet the "Recommended Side" immediately.** Use the "Human in the Loop" method:

1. **Check the "Questionables":** For G1, the Knicks have **Karl-Anthony Towns, Josh Hart, and OG Anunoby** all listed as Questionable. If all three play, your "Recommended Side" (Knicks) is a lock. If all three sit, that 12.59-point edge might actually vanish or flip.
2. **Verify the Scraper:** Since the scraper pulls from CBS, sometimes it misses a "Game Time Decision" (GTD) that was just announced on Twitter/X.
3. **The "Trap Line" Rule:** If your engine says the Knicks should be favored by 9, but Vegas has them as +3.5, ask yourself: _"What does Vegas know that my 10-game rolling average doesn't?"_ (Usually, it's a specific player matchup or a "revenge game" narrative).

---
